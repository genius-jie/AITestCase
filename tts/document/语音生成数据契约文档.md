# 语音生成数据契约文档

> 本文档定义了语音生成系统的完整数据契约，包括项目结构、数据格式、API接口和使用规范

---

## 1. 项目结构

```
e:\AI测试用例\
├── python\
│   ├── vad_test\                          # VAD测试样本生成目录
│   │   ├── generate_vad_samples.py        # 主生成脚本
│   │   ├── vad_test_data_sc025.csv        # 测试数据文件（示例）
│   │   └── vad_test_data_noise_comparison.csv  # 杂音对比测试数据
│   ├── azure_tts\                         # Azure TTS配置
│   │   └── azure_config.py                # Azure API配置文件
│   ├── audio_processing\                  # 音频处理模块
│   │   └── add_breath_sound.py            # 呼吸声添加脚本
│   ├── background_noise.mp3              # 背景噪音文件
│   └── vad_samples\                       # 生成样本输出目录
│       ├── SC025_愤怒停顿+杂音.wav
│       └── ...
├── .env                                   # 环境变量配置
└── .venv\                                 # Python虚拟环境
```

---

## 2. 核心组件说明

### 2.1 主生成脚本：generate_vad_samples.py

**功能**：
- 从CSV文件读取测试数据
- 生成符合Azure TTS规范的SSML
- 调用Azure TTS API生成语音
- 执行音频后期处理（音量调整、背景噪音混音）

**关键函数**：
- `generate_ssml()` - 生成SSML文本
- `synthesize_speech()` - 调用Azure TTS生成语音
- `process_audio_volume()` - 音量处理（淡入淡出）
- `add_background_noise()` - 添加背景噪音
- `read_test_data_from_csv()` - 读取CSV测试数据
- `generate_vad_samples()` - 主生成流程

### 2.2 Azure配置：azure_config.py

**配置项**：
```python
SPEECH_KEY = os.environ.get("AZURE_SPEECH_KEY")  # Azure API密钥
SPEECH_REGION = os.environ.get("AZURE_SPEECH_REGION")  # 服务区域
VOICE_NAME = "zh-CN-XiaoxiaoNeural"  # 语音模型
AUDIO_FORMAT = "riff-24khz-16bit-mono-pcm"  # 音频格式
OUTPUT_DIR = "../vad_samples"  # 输出目录
```

**环境变量配置**（.env文件）：
```
AZURE_SPEECH_KEY=your_api_key_here
AZURE_SPEECH_REGION=eastasia
```

### 2.3 音频处理：add_breath_sound.py

**功能**：
- 生成呼吸声样本
- 在指定位置插入呼吸声

**使用方法**：
```python
from audio_processing.add_breath_sound import add_breath_to_audio

add_breath_to_audio(
    input_path="input.wav",
    output_path="output.wav",
    breath_position_ms=1000,
    breath_duration_ms=500
)
```

---

## 3. CSV数据格式规范

### 3.1 文件格式要求

**文件编码**：UTF-8
**分隔符**：逗号（,）
**注释符号**：#（行首#表示注释，会被自动跳过）
**空行**：自动跳过

### 3.2 字段定义

| 字段名称 | 数据类型 | 必选/可选 | 取值规则 | 说明 |
|---------|---------|----------|---------|------|
| scenario_id | string | 必选 | 唯一标识，如SC001 | 测试场景ID |
| scenario_name | string | 必选 | 场景名称 | 测试场景名称 |
| text | string | 必选 | UTF-8编码 | 待合成的文本内容 |
| language | string | 可选 | 语言代码，如zh-CN/en-US/ja-JP | 语言类型，空表示默认中文 |
| dialect | string | 可选 | 方言名称，如普通话/粤语/四川话 | 方言类型，空表示标准普通话 |
| voice_name | string | 可选 | Azure TTS语音模型名称 | 语音模型，空表示使用默认模型 |
| break_time_ms | number | 可选 | 0-5000，空表示无停顿 | 停顿时长（毫秒） |
| pause_position | string | 可选 | "句首"/"句中"/"句尾" | 停顿位置 |
| add_post_process_breath | boolean | 可选 | true/false | 是否添加杂音/呼吸声 |
| breath_strength | string | 可选 | low/medium/high | 杂音强度（仅add_post_process_breath=true时有效） |
| prosody_rate | string | 可选 | slow/normal/fast 或 -50% 到 +100% | 语速调整 |
| prosody_pitch | string | 可选 | x-low/low/medium/high/x-high 或 -50% 到 +50% | 音高调整 |
| prosody_volume | string | 可选 | silent/x-soft/soft/medium/loud/x-loud | 音量调整 |
| emphasis_words | string | 可选 | 逗号分隔的词语 | 需要强调的词语 |
| style | string | 可选 | 语气风格名称 | 语气风格 |
| expected_silence | boolean | 必选 | true/false | 是否预期包含静音 |
| expected_speech | boolean | 必选 | true/false | 是否预期包含语音 |
| expected_post_process_breath | boolean | 可选 | true/false | 是否预期包含后处理添加的呼吸音 |
| vad_expected_result | string | 必选 | active/silence/active+silence+active | VAD预期检测结果 |
| priority | string | 可选 | P0/P1/P2 | 测试优先级 |
| audio_format | string | 必选 | WAV | 音频格式 |
| sample_rate | number | 必选 | 16000 | 采样率（Hz） |
| channels | number | 必选 | 1 | 声道数 |
| bit_depth | number | 必选 | 16 | 位深（bit） |

### 3.3 语气风格（style）支持列表

| 风格名称 | 说明 | 自动prosody调整 |
|---------|------|----------------|
| normal | 正常语气 | 无 |
| cheerful | 开心/愉快 | 语速+15%，音调+10% |
| serious | 严肃/正式 | 语速-10%，音调-5% |
| sad | 悲伤 | 语速-20%，音调-15% |
| excited | 兴奋/激动 | 语速+20%，音调+15% |
| angry | 愤怒 | 语速+10%，音调+5% |
| gentle | 温柔/温和 | 语速-15%，音调-5% |
| customerService | 客服语气 | 语速正常，音调正常 |

### 3.4 语言（language）支持列表

| 语言代码 | 语言名称 | 推荐语音模型 | 说明 |
|---------|---------|-------------|------|
| zh-CN | 中文（简体） | zh-CN-XiaoxiaoNeural | 默认语言 |
| zh-HK | 中文（粤语） | zh-HK-HiuMaanNeural | 粤语 |
| zh-TW | 中文（台湾） | zh-TW-HsiaoChenNeural | 台湾国语 |
| en-US | 英语（美国） | en-US-JennyNeural | 美式英语 |
| en-GB | 英语（英国） | en-GB-SoniaNeural | 英式英语 |
| ja-JP | 日语 | ja-JP-NanamiNeural | 日语 |
| ko-KR | 韩语 | ko-KR-SunHiNeural | 韩语 |

### 3.5 方言（dialect）支持列表

| 方言名称 | 对应语言代码 | 推荐语音模型 | 说明 |
|---------|-------------|-------------|------|
| 普通话 | zh-CN | zh-CN-XiaoxiaoNeural | 标准普通话 |
| 粤语 | zh-HK | zh-HK-HiuMaanNeural | 香港粤语 |
| 台湾国语 | zh-TW | zh-TW-HsiaoChenNeural | 台湾国语 |
| 四川话 | zh-CN | zh-CN-XiaoxiaoNeural | 需配合style调整 |
| 东北话 | zh-CN | zh-CN-XiaoxiaoNeural | 需配合style调整 |

### 3.6 CSV示例

```csv
scenario_id,scenario_name,text,break_time_ms,pause_position,add_post_process_breath,breath_strength,prosody_rate,prosody_pitch,prosody_volume,emphasis_words,style,expected_silence,expected_speech,expected_post_process_breath,vad_expected_result,priority,audio_format,sample_rate,channels,bit_depth
SC001,正常无停顿,今天天气真好,,,,false,,normal,,,,false,true,false,active,P0,WAV,16000,1,16
SC002,句中短停顿,今天天气真好,500,句中,false,,,,normal,,,,true,true,false,active+silence+active,P0,WAV,16000,1,16
SC003,开心语气,今天天气真好,,,,false,,normal,,cheerful,false,true,false,active,P1,WAV,16000,1,16
SC025,愤怒停顿+杂音,我草，怎么这都不懂,800,句中,true,medium,+10%,+5%,loud,,angry,false,true,true,active+silence+active,P0,WAV,16000,1,16
```

### 3.5 CSV格式注意事项

1. **注释行**：以#开头的行会被自动跳过
2. **空行**：空行会被自动跳过
3. **空值处理**：
   - `break_time_ms`：空表示无停顿
   - `pause_position`：空表示无停顿位置
   - `add_post_process_breath`：空或false表示不添加杂音
   - `style`：空或normal表示正常语气
   - `prosody_rate`：空或normal表示正常语速
4. **布尔值**：使用小写true/false
5. **编码**：必须使用UTF-8编码

---

## 4. SSML生成规则

### 4.1 SSML结构

```xml
<speak version='1.0' xmlns='http://www.w3.org/2001/10/synthesis' xml:lang='zh-CN' xmlns:mstts='http://www.w3.org/2001/mstts'>
  <voice name='zh-CN-XiaoxiaoNeural'>
    <mstts:express-as style='cheerful'>
      <prosody rate='+15%' pitch='+10%' volume='loud'>
        今天天气真好
        <audio src='https://cdn.pixabay.com/audio/2026/01/08/audio_14060a21f9.mp3'/>
        <break time='500ms'/>
        真是太棒了
      </prosody>
    </mstts:express-as>
  </voice>
</speak>
```

### 4.2 停顿位置处理

| 停顿位置 | 处理逻辑 | 示例 |
|---------|---------|------|
| 句首 | 先添加杂音+停顿，再朗读文本 | `<audio src='...'/><break time='500ms'/>今天天气真好` |
| 句中 | 在文本中间插入杂音+停顿 | `今天<audio src='...'/><break time='500ms'/>天气真好` |
| 句尾 | 先朗读文本，再添加停顿+杂音 | `今天天气真好<break time='500ms'/><audio src='...'/>` |

### 4.3 杂音URL列表

系统会从以下URL中随机选择杂音：
- `https://cdn.pixabay.com/audio/2025/11/07/audio_d613f744f2.mp3`
- `https://cdn.pixabay.com/audio/2026/01/08/audio_14060a21f9.mp3`
- `https://cdn.pixabay.com/audio/2024/09/20/audio_9c10ad2e35.mp3`
- `https://cdn.pixabay.com/audio/2024/09/20/audio_31602561df.mp3`
- `https://cdn.pixabay.com/audio/2021/08/04/audio_209174bd86.mp3`

---

## 5. 音频后期处理

### 5.1 音量处理

**功能**：添加淡入淡出效果，使音频更自然

**参数**：
- `fade_duration`：渐变时长（毫秒），默认100ms

**实现**：
```python
from pydub import AudioSegment

audio = AudioSegment.from_wav(input_path)
processed_audio = audio.fade_in(fade_duration).fade_out(fade_duration)
```

### 5.2 背景噪音混音

**功能**：添加真实的背景噪音

**参数**：
- `noise_level`：噪音音量（dB），默认-30dB
- `background_file`：背景噪音文件路径，默认`../background_noise.mp3`

**处理逻辑**：
1. 加载TTS生成的音频
2. 加载背景噪音文件
3. 调整背景噪音长度：
   - 如果背景噪音长于TTS音频：裁剪到TTS长度
   - 如果背景噪音短于TTS音频：循环播放到TTS长度
4. 调整背景噪音音量（-30dB）
5. 混音：TTS音频 + 背景噪音
6. 保存结果

**实现**：
```python
from pydub import AudioSegment

tts_audio = AudioSegment.from_wav(tts_path)
background = AudioSegment.from_mp3(background_file)

# 调整长度
if len(background) > len(tts_audio):
    background = background[:len(tts_audio)]
elif len(background) < len(tts_audio):
    loop_count = int(len(tts_audio) / len(background)) + 1
    background = background * loop_count
    background = background[:len(tts_audio)]

# 调整音量并混音
background = background + noise_level
mixed = tts_audio.overlay(background)
```

---

## 6. 生成流程

### 6.1 完整生成流程

```
1. 读取CSV测试数据
   ↓
2. 验证Azure配置
   ↓
3. 创建输出目录
   ↓
4. 遍历每个测试场景
   ↓
5. 生成SSML文本
   ↓
6. 调用Azure TTS API生成语音
   ↓
7. 音量处理（淡入淡出）
   ↓
8. 添加背景噪音（如果需要）
   ↓
9. 保存到输出目录
   ↓
10. 输出统计信息
```

---

## 7. 输出文件规范

### 7.1 文件命名规则

**格式**：`{scenario_id}_{scenario_name}.wav`

**示例**：
- `SC025_愤怒停顿+杂音.wav`
- `SC100_正常背景杂音.wav`
- `SC200_句首停顿+杂音.wav`

### 7.2 输出目录

**默认路径**：`e:\AI测试用例\python\vad_samples\`

**配置方式**：在`azure_config.py`中修改`OUTPUT_DIR`变量

### 7.3 音频格式

- **格式**：WAV
- **采样率**：24000Hz（由Azure TTS决定）
- **声道数**：1（单声道）
- **位深**：16位

---

## 8. 扩展功能

### 8.1 支持的音频格式

当前支持：WAV格式

计划支持：
- MP3
- OGG
- FLAC

### 8.2 自定义杂音URL

可以在`generate_ssml()`函数中修改`noise_urls`列表，添加自定义杂音URL。

### 8.3 批量生成

脚本支持从CSV文件批量生成多个语音样本。

---

## 9. 最佳实践

### 9.1 CSV数据设计

1. **场景覆盖**：确保覆盖正常、异常、边界场景
2. **优先级设置**：P0为核心场景，P1为重要场景，P2为辅助场景
3. **命名规范**：场景ID使用SC+三位数字，场景名称清晰描述
4. **注释使用**：在CSV中使用#添加注释，便于理解

### 9.2 语音参数调整

1. **语速调整**：
   - 快速语音：+15% 到 +20%
   - 正常语音：normal
   - 慢速语音：-15% 到 -20%

2. **音调调整**：
   - 高音调：+10% 到 +15%
   - 正常音调：normal
   - 低音调：-10% 到 -15%

3. **音量调整**：
   - 高音量：loud
   - 正常音量：medium
   - 低音量：soft

### 9.3 测试场景设计

1. **正常场景**：标准语音、自然停顿
2. **异常场景**：噪音干扰、快速/慢速语音
3. **边界场景**：极短/极长停顿、微弱呼吸

---

## 10. 版本信息

- **文档版本**：2.0
- **创建日期**：2026-01-10
- **最后更新**：2026-01-10
- **架构版本**：分层架构 v1.0

---

## 11. 附录

### 11.1 完整CSV示例文件

```csv
# VAD测试数据文件
# 说明：本文件定义了各种VAD测试场景的参数配置

scenario_id,scenario_name,text,break_time_ms,pause_position,add_post_process_breath,breath_strength,prosody_rate,prosody_pitch,prosody_volume,emphasis_words,style,expected_silence,expected_speech,expected_post_process_breath,vad_expected_result,priority,audio_format,sample_rate,channels,bit_depth

# 背景杂音测试用例
SC100,正常背景杂音,今天天气真好,,normal,true,medium,normal,,normal,,normal,false,true,true,active+silence,P0,WAV,16000,1,16
SC101,快速背景杂音,今天天气真好,,normal,true,medium,fast,,normal,,excited,false,true,true,active,P0,WAV,16000,1,16
SC102,慢速背景杂音,今天天气真好,,normal,true,medium,slow,,normal,,gentle,false,true,true,active,P0,WAV,16000,1,16

# 停顿+杂音测试用例
SC200,句首停顿+杂音,今天天气真好,1000,句首,false,,normal,,normal,,normal,false,true,false,active+silence+active,P0,WAV,16000,1,16
SC201,句中停顿+杂音,今天天气真好,1000,句中,false,,normal,,normal,,normal,false,true,false,active+silence+active,P0,WAV,16000,1,16
SC202,句尾停顿+杂音,今天天气真好,1000,句尾,false,,normal,,normal,,normal,false,true,false,active+silence,P0,WAV,16000,1,16
SC203,开心停顿+杂音,太棒了！我们成功了！,500,句中,false,,normal,,normal,,cheerful,false,true,false,active+silence+active,P0,WAV,16000,1,16
SC204,悲伤停顿+杂音,我很难过，失去了机会,500,句中,false,,normal,,normal,,sad,false,true,false,active+silence+active,P0,WAV,16000,1,16
```

### 11.2 依赖库清单

```
azure-cognitiveservices-speech>=1.30.0
pydub>=0.25.1
python-dotenv>=1.0.0
```

### 11.3 环境要求

- Python >= 3.8
- Azure TTS API密钥
- FFmpeg（pydub依赖）

---

**文档结束**
