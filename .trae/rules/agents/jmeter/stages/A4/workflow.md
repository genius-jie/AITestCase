@workflow_type: structural
@usage_mode: generation
@enforcement: executable
@version: 3.0.0
@author: QA Team
@description: A4阶段工作流 - 测试数据生成与脚本适配（宪法级规范适配版）
@created_at: 2026-01-15
@last_updated: 2026-01-15
@update_note: 适配宪法级JMeter脚本设计规范，强制前置测试类型声明

# 重要说明

**在执行本阶段任务前，必须首先阅读并理解以下宪法级规范文档：**

- [JMeter脚本设计规范.md](file:///e:/AI测试用例/.trae/rules/agents/jmeter/JMeter脚本设计规范.md)
- [数据来源决策模型.md](file:///e:/AI测试用例/.trae/rules/agents/jmeter/数据来源决策模型.md)

## 宪法级约束（强制前置）

**在执行任何脚本设计前，必须明确数据策略执行角色：**

```text
A4-A5角色 = 数据策略执行者（非决策者）
```

**数据策略执行原则：**
- ✅ 严格执行A1-A3阶段已批准的数据策略
- ✅ 不得自行引入/移除CSV
- ✅ 不得推翻A1-A3的决策
- ❌ 禁止将CSV使用与测试类型硬绑定
- ❌ 禁止在A4-A5阶段自行决策数据策略

**CSV是否使用是数据策略问题，不是测试类型问题！**

# A4 Automate - 数据构造与工具适配

## 适用场景
- 接口测试数据构造
- 基于A3输出进行测试数据生成
- 测试工具适配与配置
- 测试数据与脚本的映射关系定义
- **业务规则变更时的脚本本文档更新 + 数据设计**

## 核心特点
- ✅ 构造接口测试数据（严格遵循宪法级规范）
- ✅ 生成测试工具参数化与配置说明
- ✅ 明确脚本与数据的映射关系
- ✅ 补全A4阶段三件套文档
- ✅ **响应业务规则变更，更新脚本本文档 + 重新设计测试数据**

## 核心执行原则

### P0｜宪法级规范强制遵循（最高优先级）
1. **强制前置阅读**：在执行任何脚本设计前，必须首先阅读并理解 [JMeter脚本设计规范.md](file:///e:/AI测试用例/接口测试/docs/JMeter脚本设计规范.md)
2. **严格遵循所有规范章节**：所有脚本设计必须严格遵循规范中的所有章节要求
3. **禁止违反规范**：任何违反规范的操作都是禁止的
4. **规范优先级**：当其他要求与规范冲突时，以规范为准
5. **持续参考规范**：在执行过程中遇到不确定的问题时，必须首先查阅规范

## 阶段划分

### 阶段1: 测试类型声明与数据设计
@phase_id: A4-1
@role: 测试类型声明Agent
@output: [测试类型声明文档]
@human_review: required
@metadata:
  core_objectives: 声明测试类型并设计测试数据
  key_nodes: 测试类型声明节点
  references: JMeter脚本设计规范.md 第0章

#### 宪法级前置条件
**必须首先阅读并理解**：[JMeter脚本设计规范.md](file:///e:/AI测试用例/接口测试/docs/JMeter脚本设计规范.md) 第0章"使用说明"

#### 核心动作
1. **强制声明测试类型**：根据任务需求明确声明 `test_type = function | performance`
2. **验证章节使用权限**：确认当前测试类型允许使用的规范章节
3. **设计测试数据策略**：
   - **功能测试**：参考规范第6章"功能测试脚本设计规范"
   - **性能测试**：参考规范第8章"性能测试脚本设计规范"
4. 输出测试类型声明文档

### 阶段2: 测试数据生成（宪法级规范适配）
@phase_id: A4-2
@role: 测试数据生成Agent
@output: [测试数据集]
@human_review: required
@metadata:
  core_objectives: 生成符合宪法级规范的接口测试数据
  key_nodes: 数据验证节点
  references: JMeter脚本设计规范.md 第3章、第6章、第8章

#### 前置条件
**必须首先完成测试类型声明**：确保已明确 `test_type = function | performance`

#### 核心动作
1. **根据测试类型选择数据生成策略**：

   **功能测试数据生成**（参考规范第6章）：
   - **CSV驱动**：使用CSV文件管理测试数据
   - **全面覆盖**：设计正例、反例、边界例、鲁棒性例
   - **参数分类明确**：区分脚本使用字段和用户查看字段
   - **不变字段识别**：识别一直不变的字段，写入JMX脚本的用户定义变量

   **性能测试数据生成**（参考规范第8章）：
   - **无CSV依赖**：禁止使用CSV数据源
   - **动态生成**：所有必要数据通过动态生成方式获取
   - **参数唯一性**：关键参数（如version）必须保持不同
   - **无反例设计**：禁止设计反例测试用例及边界条件测试用例
   - **文件上传配置**：文件上传接口必须使用Files Upload配置，不能放在Parameter中（参考规范第4.3节"文件上传接口配置规范"）

2. **严格遵循宪法级约束**：
   - ❌ 禁止功能/性能规则混用
   - ❌ 禁止幻觉捏造测试数据值
   - ❌ 禁止在未声明test_type的情况下生成脚本
   - ✅ 严格按照允许使用的规范章节执行

3. 对生成的数据进行验证
4. 输出标准化测试数据集
5. 存储到测试资产库

### 阶段3: 测试工具适配
@phase_id: A4-3
@role: 测试工具适配Agent
@output: [测试工具配置说明, 调试报告]
@human_review: required
@metadata:
  core_objectives: 适配测试工具，解决脚本问题
  key_nodes: 配置验证节点，调试验证节点
  references: stages/A3/output.md, 接口分析文档, 工具组件参考文档

#### 核心动作
1. 根据接口测试需求，配置测试计划
2. 定义测试工具参数化策略
3. 配置测试工具监控和报告
4. 生成初始测试脚本
5. **调试与验证**：
   - 使用排除法调试思路验证脚本，告诉用户当前脚本用到了哪些组件，哪些组件可能存在问题，以及如何定位和解决。
   - 简化脚本：创建基础版本，逐步添加组件
   - 对比分析：与可正常工作的脚本对比结构差异
   - 分阶段验证：每次修改后立即验证
   - 组件隔离：单独测试可疑组件
   - 参考规范：对照测试工具组件参考文档
   - 多模式验证：同时验证GUI和非GUI模式
6. 输出测试工具配置说明和调试报告

### 阶段4: 脚本与数据映射
@phase_id: A4-4
@role: 脚本与数据映射Agent
@output: [脚本与数据映射关系文档]
@human_review: required
@metadata:
  core_objectives: 明确脚本与数据的映射关系
  key_nodes: 映射验证节点
  references: 测试工具配置说明、测试数据集

#### 核心动作
1. 明确测试脚本与测试数据的映射关系
2. **参数来源分析与分类**：
   - **CSV参数**：仅对真正需要人工控制、覆盖特定场景的参数使用CSV（如：特定账号、特定业务状态数据）
   - **动态参数**：时间戳、随机数、UUID等使用JMeter内置函数生成
   - **关联参数**：依赖上游接口的参数，直接从接口响应提取
3. 定义数据驱动策略
4. 输出脚本与数据映射关系文档，**必须标注每个参数的来源类型（CSV/Function/Extract）**

#### 参数设计原则
- **最小化 CSV 依赖**：避免 CSV 过大、难维护、版本冲突
- **优先动态生成**：提高脚本的可重复执行性
- **变量传递优先链路**：保证链路可达性，减少数据耦合
- **数据可复用 & 可追溯**：CSV 维护的参数要有版本、来源说明

### 阶段5: 阶段文档补全
@phase_id: A4-5
@role: 文档补全Agent
@output: [补全后的阶段三件套文档]
@human_review: optional
@metadata:
  core_objectives: 补全阶段三件套文档
  key_nodes: 文档审核节点
  references: 所有前期输出文档

#### 核心动作
1. 补全A4阶段workflow.md执行细节
2. 强化A4阶段role.prompt.md中的职责、能力与输出要求
3. 在mistakes.md中沉淀本阶段易错点，包括调试方法和经验
4. 输出完整的阶段三件套文档

## 六、落地建议
- **宪法级约束优先**：严格遵守测试类型声明和章节使用权限
- **文档先行**：每个阶段启动前先生成对应节点工作流文档
- **保留人工入口**：关键节点人工介入
- **可选使用 & 可组合使用**：Agent可根据任务需求选择和覆盖模板
- **版本管理**：记录版本变化
- **调试方法**：采用排除法调试思路，简化脚本、对比分析、分阶段验证、组件隔离、参考规范、多模式验证
- **脚本验证**：生成脚本后必须同时验证GUI模式和非GUI模式，确保脚本可正常使用

## 七、Skill能力映射

### 7.1 核心职责与能力需求分析
**A4阶段核心职责**：测试数据生成与脚本适配，严格执行已批准的数据策略，构造接口测试数据，生成测试工具参数化与配置说明，明确脚本与数据的映射关系。

### 7.2 针对性Skill能力映射

| 能力类别 | 适用Skill | 能力等级 | 应用场景 | 核心价值 |
|---------|---------|---------|---------|---------|
| **测试数据设计** | 接口测试数据设计 | L1 | 测试数据生成、数据驱动策略设计、脚本数据映射 | 提供标准化的测试数据设计能力，确保数据符合业务逻辑和格式规范 |
| **组件配置** | JMeter 组件层设计 | L2 | 测试工具适配、组件配置、GUI/CLI兼容性保证 | 为测试工具提供标准化的组件配置，确保脚本结构正确 |
| **方法封装** | JMeter 方法层设计 | L3 | 脚本与数据映射、参数化设计、变量传递 | 提供脚本与数据的映射能力，处理参数传递和依赖关系 |
| **执行验证** | JMeter 执行层设计 | L4 | 执行调试、结果分析、迭代优化 | 提供执行调试能力，确保脚本真正可用 |

### 7.3 阶段专属Skill能力配置

**A4阶段专属能力配置**：
- ✅ **接口测试数据设计**：用于构造符合业务规则的测试数据，生成数据驱动策略
- ✅ **JMeter 组件层设计**：用于生成符合规范的JMX骨架和组件配置
- ✅ **JMeter 方法层设计**：用于封装测试方法，处理参数映射和变量传递
- ⚠️ **JMeter 执行层设计**：仅用于执行验证和调试，不用于完整执行流程

**能力使用原则**：
- **数据策略执行**：严格执行A1-A3阶段已批准的数据策略，不得自行决策
- **最小化CSV依赖**：优先使用动态生成和接口关联，仅对必要场景使用CSV
- **GUI兼容性**：确保生成的脚本在GUI模式下可正常打开和编辑
- **执行验证**：对生成的脚本进行基本的执行验证，确保脚本结构正确