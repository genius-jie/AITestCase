@workflow_type: structural
@usage_mode: execution
@enforcement: executable
@version: 3.0.0
@author: QA Team
@description: A5阶段工作流 - 执行可达性、断言设计与上下游变量传递（宪法级规范适配版）
@created_at: 2026-01-15
@last_updated: 2026-01-15
@update_note: 适配宪法级JMeter脚本设计规范，强制前置测试类型声明

# 重要说明

**在执行本阶段任务前，必须首先阅读并理解以下宪法级规范文档：**

- [JMeter脚本设计规范.md](file:///e:/AI测试用例/接口测试/docs/JMeter脚本设计规范.md)
- [数据来源决策模型.md](file:///e:/AI测试用例/接口测试/docs/数据来源决策模型.md)

## 宪法级约束（强制前置）

**在执行任何脚本设计前，必须明确数据策略执行角色：**

```text
A4-A5角色 = 数据策略执行者（非决策者）
```

**数据策略执行原则：**
- ✅ 严格执行A1-A3阶段已批准的数据策略
- ✅ 不得自行引入/移除CSV
- ✅ 不得推翻A1-A3的决策
- ❌ 禁止将CSV使用与测试类型硬绑定
- ❌ 禁止在A4-A5阶段自行决策数据策略

**CSV是否使用是数据策略问题，不是测试类型问题！**

# A5 Apply - 执行可达性验证、断言设计与上下游变量传递

## 一、阶段定位
A5 的目标：

> 在真实环境中验证脚本可执行性、完成断言设计、并尝试上下游接口关联与变量传递，使脚本可被人工高效接手。

成功标准：

- 脚本结构完整（严格遵循宪法级规范）
- 接口可达性已验证
- 断言设计完成，判责明确
- 上下游接口关联与变量传递尝试完成或明确中断原因

---

## 二、适用场景
- 接口 / WebSocket / 混合协议测试
- 自动生成脚本后的首次验证与调试
- 接口链路复杂、上下游变量多的场景
- **业务规则变更时的脚本可达性验证和断言调整**

---

## 三、核心执行原则

### P0｜宪法级规范强制遵循（最高优先级）
1. **强制前置阅读**：在执行任何脚本设计前，必须首先阅读并理解 [JMeter脚本设计规范.md](file:///e:/AI测试用例/接口测试/docs/JMeter脚本设计规范.md)
2. **严格遵循所有规范章节**：所有脚本设计必须严格遵循规范中的所有章节要求
3. **禁止违反规范**：任何违反规范的操作都是禁止的
4. **规范优先级**：当其他要求与规范冲突时，以规范为准
5. **持续参考规范**：在执行过程中遇到不确定的问题时，必须首先查阅规范

### P1｜宪法级测试类型前置
1. 强制声明测试类型：`test_type = function | performance`
2. 验证章节使用权限
3. 严格遵循对应测试类型的规范章节

### P2｜阶段化执行
1. 单接口可达 → 断言设计 → 上下游接口关联与变量传递
2. 每阶段完成后输出结果文档，可被下一阶段直接复用

### P3｜断言设计与判责
- 前提：单接口可达
- 系统问题（System Fault）：不可达 / HTTP 5xx / 返回字段缺失或值违反业务规则 → BUG
- 测试设计问题（Test Design Fault）：断言不合理 → 可自动调整 ≤3次
- 对依赖接口必须在组合场景下验证可达
- 单接口可达仅作为基本检查，不代表链路可达

### P4｜上下游变量传递
- Agent 尝试自动配置接口间关联
- 自动重试 ≤3次
- 超过阈值或无法稳定执行 → 请求人工介入

### P5｜最大成功样本基准（Baseline）
- 所有分析与配置基于真实成功响应

### P6｜有限自愈，禁止死循环
- 单阶段重试 ≤3次
- 超过阈值必须中断并请求人工介入

### P7｜参数动态生成与验证
- 执行脚本时，将动态函数直接放入请求参数
- 对 CSV 读取的数据进行可达性验证
- 在 Baseline 样本中记录实际值（特别是随机生成的）

---

## 四、阶段划分

### 阶段 A5-1：宪法级测试类型声明与脚本工程骨架搭建
@phase_id: A5-1
@role: 宪法级脚本工程构建 Agent
@output: [测试类型声明文档 + JMeter 脚本工程（无断言）]
@human_review: required
@metadata:
  core_objectives: 声明测试类型并构建脚本工程骨架
  key_nodes: 测试类型声明节点、组件配置节点
  references: JMeter脚本设计规范.md 第0章、第4章

#### 宪法级前置条件
**必须首先阅读并理解**：[JMeter脚本设计规范.md](file:///e:/AI测试用例/接口测试/docs/JMeter脚本设计规范.md) 第0章"使用说明"

#### 核心动作
1. **强制声明测试类型**：根据任务需求明确声明 `test_type = function | performance`
2. **验证章节使用权限**：确认当前测试类型允许使用的规范章节
3. **按照规范第4.1节组件顺序规范创建脚本结构**
4. **根据测试类型配置脚本参数**：

   **接口测试脚本配置**（参考规范第6章）：
   - 引入环境变量、用户定义变量（参考规范第9章）
   - 引入环境变量初始化组件（参考规范第9章）
   - **数据策略驱动**：根据数据策略决定是否使用CSV
   - **动态参数生成**：使用JSR223 PreProcessor生成动态参数
   - **断言设计**：根据测试需求设计适当的断言
   - **场景化测试**：覆盖正常、异常、边界场景
   - 配置HTTP请求默认值使用动态环境变量（参考规范第9章）

   **性能测试脚本配置**（参考规范第8章）：
   - 引入环境变量、用户定义变量（参考规范第9章）
   - 引入环境变量初始化组件（参考规范第9章）
   - **引入性能测试专用动态参数生成器**（参考规范第8章）
   - 配置HTTP请求默认值使用动态环境变量（参考规范第9章）
   - **无CSV依赖**：禁止配置CSV Data Set Config
   - **文件上传配置**：文件上传接口必须使用Files Upload配置，不能放在Parameter中（参考规范第4.3节"文件上传接口配置规范"）

5. 引入 Result Tree / 基础监听器
6. 将所有待测接口加入脚本（无断言）
7. **严格遵循请求头管理策略**（参考规范第4章）
8. **添加环境切换说明**（参考规范第9章）
9. **添加测试类型说明**：在脚本注释中明确标注测试类型（功能测试/性能测试）

---

### 阶段 A5-2：接口可达性验证（宪法级规范适配）
@phase_id: A5-2
@role: 宪法级可达性验证 Agent
@output: [接口可达性验证结果]
@human_review: required

**核心目标**：
验证接口在真实环境下是否可达，同时考虑接口依赖关系（例如登录获取 token，其他接口依赖 token）。

**执行动作**：
1. **宪法级验证**：确认当前脚本符合声明的测试类型规范
2. **根据测试类型执行验证**：

   **接口测试验证**：
   - 验证数据可达性：确保数据源路径正确，数据格式符合接口要求
   - 验证动态参数生成：确保JSR223 PreProcessor正确生成动态参数
   - 验证环境变量传递：确保动态环境变量正确传递到HTTP请求
   - 验证参数唯一性：确保并发场景下参数不会冲突
   - **命令行参数**：使用`jmeter -n -t script.jmx -Jenv=test -l results.jtl`（标准接口测试，禁用HTML报告）
   - **调试模式**：使用`jmeter -n -t script.jmx -Jenv=test -l results.jtl -e -o report`（仅用于问题排查）

3. 对单接口：使用固定参数值调用接口，检查接口响应状态
4. 对依赖接口链路：按依赖顺序执行前置接口，捕获前置接口输出，验证组合接口链路可达性
5. 输出：
   - 当前脚本版本
   - 已尝试修改点
   - 疑问组件（参数、Header、鉴权、前置条件）
   - 依赖链路配置说明
   - **宪法级验证结果**：确认脚本符合测试类型规范

---

### 阶段 A5-3：Baseline 样本捕获（宪法级规范适配）
@phase_id: A5-3
@role: 宪法级基准样本分析 Agent
@output: [Baseline 响应样本]
@human_review: required

**核心动作**：
1. 在所有成功响应中选取信息最完整的样本
2. **记录实际参数值**：特别关注动态生成的参数值（如随机数、时间戳）和CSV读取的参数值
3. **记录动态参数生成结果**：记录JSR223 PreProcessor生成的动态参数值，确保可追溯性
4. **宪法级验证**：确认Baseline样本符合当前测试类型规范
5. 保存请求参数、响应 Header、响应 Body

---

### 阶段 A5-4：宪法级断言设计与脚本配置
@phase_id: A5-4
@role: 宪法级脚本设计与断言 Agent
@output: [脚本设计说明文档 + 断言配置]
@human_review: required
@metadata:
  core_objectives: 设计符合宪法级规范的断言和脚本配置
  key_nodes: 断言设计节点
  references: JMeter脚本设计规范.md 第5章、第6章、第8章

#### 前置条件
**必须首先阅读并理解**：[JMeter脚本设计规范.md](file:///e:/AI测试用例/接口测试/docs/JMeter脚本设计规范.md) 第5章"断言设计总则"、第6章"功能测试脚本设计规范"、第8章"性能测试脚本设计规范"

**核心动作**：
1. **根据测试类型选择断言设计策略**：

   **功能测试断言设计**（参考规范第6章）：
   - 根据 Baseline 样本设计断言（参考规范第5章）
   - 严格遵循断言设计原则：基于Baseline样本设计、场景化断言实现、判责明确
   - 判责：系统问题 → 记录为 BUG，不调整；测试设计问题 → 自动调整 ≤3次
   - 配置JSR223组件：使用正确的guiclass="TestBeanGUI"，遵循变量安全处理原则

   **性能测试断言设计**（参考规范第8章）：
   - 仅验证 HTTP 可达性
   - 仅验证基础业务成功
   - 禁止复杂业务断言
   - 配置性能测试专用断言组件

2. 分析接口上下游调用顺序、输入输出字段映射关系、必须传递变量
3. 建议断言点（结构 / 状态 / 业务）
4. **宪法级验证**：确认断言设计符合当前测试类型规范
5. 输出断言配置及调整记录

**重要注意事项**：
- **JSR223Assertion组件配置**：必须使用`guiclass="TestBeanGUI"`，不能使用`JSR223AssertionGui`，否则会导致GUI模式下无法打开脚本
- **JSON字段提取必须基于Baseline样本**：在编写JSR223PostProcessor提取变量时，必须先分析Baseline样本中的实际响应体结构，确定正确的字段访问路径
- **动态推理字段层级**：根据实际响应体的JSON结构，确定正确的字段访问路径，不能假设字段名与变量名相同
- **在提取脚本中添加调试日志**：使用`log.info("完整响应: " + response)`和`log.info("提取的值: " + extractedValue)`便于调试

### **请求头管理策略（新增）**
- 登录接口前只设置Content-Type
- 登录接口后设置全局请求头管理器
- 后续接口复用全局请求头

---

## 五、宪法级执行约束

### 5.1 测试类型约束
- **必须前置声明**：在执行任何脚本设计前必须先声明测试类型
- **禁止规则混用**：功能测试和性能测试规则严禁混用
- **章节权限控制**：严格按照允许使用的规范章节执行

### 5.2 数据设计约束
- **功能测试**：必须使用CSV数据驱动，全面覆盖各种场景
- **性能测试**：禁止使用CSV，所有参数必须动态生成

### 5.3 断言设计约束
- **功能测试**：必须设计详细的业务逻辑验证
- **性能测试**：仅验证基本可达性，禁止复杂业务断言

### 5.4 错误处理约束
- 单阶段重试 ≤3次
- 超过阈值必须中断并请求人工介入
- 所有错误必须可解释、可交接

---

## 六、落地建议
- **宪法级约束优先**：严格遵守测试类型声明和章节使用权限
- **文档先行**：每个阶段启动前先生成对应节点工作流文档
- **保留人工入口**：关键节点人工介入
- **可选使用 & 可组合使用**：Agent可根据任务需求选择和覆盖模板
- **版本管理**：记录版本变化
- **调试方法**：采用排除法调试思路，简化脚本、对比分析、分阶段验证、组件隔离、参考规范、多模式验证
- **脚本验证**：生成脚本后必须同时验证GUI模式和非GUI模式，确保脚本可正常使用