@skill_name: JMeter 方法层设计
@skill_level: L3
@skill_type: 方法设计
@domain: 接口测试 / JMeter / 自动化测试
@input_contract:
  - component_assets: A5阶段/组件层资产/组件资产目录/
  - interface_definitions: ${resources_dir}/docs/接口定义.md
  - test_scenarios: ${resources_dir}/docs/测试场景.md
  - data_strategy: ${resources_dir}/docs/data_strategy.yaml
  - component_config: ${resources_dir}/config/component_config.yaml
  - component_templates: A5阶段/组件层资产/组件库目录/
  - assertion_config: A5阶段/组件层资产/断言配置目录/
  - extraction_rules: A5阶段/组件层资产/变量提取目录/
  - validation_report: A5阶段/组件层资产/验证报告目录/
@output_artifact:
  - executable_jmx: ${resources_dir}/scripts/executable_test.jmx
  - parameter_mapping: ${resources_dir}/config/parameter_mapping.yaml
  - test_method_docs: ${resources_dir}/docs/test_method_docs.md
  - assertion_config: ${resources_dir}/config/assertion_config.yaml
  - execution_plan: ${resources_dir}/docs/execution_plan.md
@enforcement: 必须生成可执行的JMX文件，保证参数映射正确
@on_missing_input: 返回错误，要求提供完整的组件资产和接口定义

---

# Skill 目标
- 为JMeter测试提供标准化的方法层设计能力
- 调用组件设计测试场景，封装方法能力
- 输出可执行的JMX文件和参数映射
- 确保测试方法的可复用性和可维护性
- 支持断言设计和判责
- 处理上下游接口关联和变量传递
- 保证GUI模式与CLI模式兼容
- 提供标准化的测试方法设计流程

# 输入说明
- **component_assets**：组件资产库，包含可复用的组件模板，保存在A5阶段的组件层资产/组件资产目录
- **interface_definitions**：接口定义文档，包含接口路径、方法、参数
- **test_scenarios**：测试场景定义，包含场景描述和预期结果
- **data_strategy**：数据策略文档，包含CSV使用决策和动态参数策略
- **component_config**：组件配置文档，包含组件详细配置
- **component_templates**：可复用的组件模板库，保存在A5阶段的组件层资产/组件库目录
- **assertion_config**：断言配置规则，保存在A5阶段的组件层资产/断言配置目录
- **extraction_rules**：变量提取规则，保存在A5阶段的组件层资产/变量提取目录
- **validation_report**：组件验证报告，保存在A5阶段的组件层资产/验证报告目录

# 输出说明
- **executable_jmx**：可直接执行的JMeter测试计划文件
- **parameter_mapping**：参数映射文档，定义参数传递关系
- **test_method_docs**：测试方法文档，描述测试方法设计和执行流程
- **assertion_config**：断言配置文档，定义断言规则和判责标准
- **execution_plan**：执行计划文档，描述测试执行策略

## 输出格式示例

### 参数映射示例
```yaml
parameter_mapping:
  interfaces:
    - name: "登录接口"
      parameters:
        - name: "username"
          source: "csv"
          csv_column: "username"
        - name: "password"
          source: "csv"
          csv_column: "password"
      outputs:
        - name: "access_token"
          target: "variable"
          variable_name: "access_token"
    - name: "后续接口"
      parameters:
        - name: "token"
          source: "variable"
          variable_name: "access_token"
```

# 执行约束
- 严格遵循组件资产的使用规范
- 保证生成的JMX文件可在GUI和CLI模式下执行
- 确保参数映射正确，变量传递顺畅
- 断言设计必须明确判责标准
- 测试方法设计必须覆盖所有测试场景
- 输出文档必须结构化、可解析
- 输入缺失或格式错误 → 返回错误，不执行生成

# 核心功能

## 1. 测试场景设计
- **场景分析**：分析测试场景，确定测试步骤和流程
- **步骤设计**：设计详细的测试步骤和执行顺序
- **依赖处理**：处理接口间依赖关系，确定执行顺序
- **场景覆盖**：确保覆盖所有测试场景和边界情况

## 2. 方法封装能力
- **方法抽象**：将测试步骤抽象为可复用的测试方法
- **参数化设计**：设计灵活的参数化测试方法
- **返回值处理**：处理方法返回值，支持链式调用
- **异常处理**：设计健壮的异常处理机制

## 3. JMX生成能力
- **组件组装**：根据测试场景组装组件资产
- **配置集成**：集成组件配置和数据策略
- **参数映射**：生成参数映射和变量传递配置
- **断言配置**：配置断言规则和判责标准
- **GUI兼容性**：确保生成的JMX文件在GUI模式下可打开

## 4. 断言设计与判责
- **断言策略**：根据测试场景设计断言策略
- **判责标准**：明确系统问题与测试设计问题的判责标准
- **场景化断言**：设计场景化的断言逻辑
- **错误处理**：设计合理的错误处理机制

## 5. 上下游关联处理
- **变量提取**：设计JSON字段提取规则，基于实际响应体结构
- **变量传递**：处理接口间变量传递和依赖关系
- **链路执行**：设计接口链路的执行顺序和依赖处理
- **参数传递**：处理复杂的参数传递和转换逻辑

## 6. 执行计划设计
- **执行策略**：设计测试执行策略和流程
- **环境配置**：配置测试环境和执行参数
- **监控设计**：设计测试执行监控和日志记录
- **报告设计**：设计测试报告和结果分析

# 执行流程
1. **输入分析**：分析组件资产、接口定义、测试场景等输入
2. **场景设计**：设计测试场景和执行步骤
3. **方法封装**：封装测试方法，设计参数化和返回值
4. **组件组装**：根据测试场景组装组件资产
5. **参数映射**：设计参数映射和变量传递
6. **断言配置**：配置断言规则和判责标准
7. **JMX生成**：生成可执行的JMX文件
8. **兼容性验证**：确保GUI和CLI模式兼容
9. **文档生成**：生成测试方法文档和执行计划
10. **输出交付**：交付最终的可执行JMX和相关文档

# 更新迭代机制

## 项目输出产物更新机制（自主迭代）
- **适用范围**：数据契约、组件语法、JMeter脚本等项目交付物
- **更新规则**：
  - **自主迭代优化**：Agent可以自动进行迭代优化更新，无需用户驱动
  - **持续改进**：根据执行结果和分析发现，自动优化交付物质量
  - **验证机制**：每次更新后自动验证更新结果的正确性
  - **可追溯性**：记录更新历史，便于审计和回退

## 触发条件
- 脚本执行失败，需要调整配置
- 断言设计不合理，需要优化
- 上下游关联处理不当，需要改进
- 性能问题，需要优化执行效率
- 业务规则变更，需要调整脚本逻辑

## 更新流程
1. **检测阶段**：分析执行结果，识别需要优化的项目交付物
2. **执行阶段**：自动执行项目交付物的优化更新
3. **验证阶段**：验证更新后的交付物执行正确、稳定
4. **反馈阶段**：向用户反馈更新结果及优化效果

## 变更历史记录
```yaml
change_history:
  - timestamp: <时间戳>
    change_type: <更新类型>
    changed_files:
      - <文件路径>
    changes:
      - <变更内容>
    requested_by: agent
    executed_by: agent
    update_type: project_delivery
```

## 反馈机制
- 更新成功：返回更新后的交付物路径、优化内容摘要、执行效果
- 更新失败：返回失败原因、错误信息、回退建议
- 部分更新：返回成功更新的部分和失败的部分

# 失败处理

## 配置错误
- 组件资产缺失 → 返回错误并提示补充
- 接口定义不完整 → 返回错误并要求提供完整定义
- 测试场景不明确 → 返回错误并要求明确场景
- 数据策略冲突 → 返回错误并提示调整策略

## 生成错误
- JMX结构错误 → 返回错误并提供具体位置
- 参数映射错误 → 返回错误并建议正确映射
- 断言配置错误 → 返回错误并提供修复建议
- 兼容性问题 → 返回错误并提示修复GUI兼容性

## 执行错误
- 接口可达性问题 → 返回错误并提示检查接口状态
- 变量传递失败 → 返回错误并建议调整提取规则
- 断言失败 → 分析失败原因并提供判责建议
- 执行超时 → 返回错误并建议调整超时设置

# 最佳实践

## 测试场景设计最佳实践
- **场景覆盖**：确保覆盖所有测试场景和边界情况
- **步骤清晰**：设计清晰、可执行的测试步骤
- **依赖明确**：明确接口间依赖关系和执行顺序
- **场景独立**：确保测试场景之间相互独立，便于单独执行

## 方法封装最佳实践
- **职责单一**：每个测试方法只负责一个功能点
- **参数化设计**：设计灵活的参数化测试方法
- **返回值规范**：统一返回值格式，支持链式调用
- **异常处理**：设计健壮的异常处理机制

## JMX生成最佳实践
- **组件复用**：充分利用组件资产，避免重复配置
- **结构清晰**：生成结构清晰、易于维护的JMX文件
- **参数映射**：确保参数映射正确，变量传递顺畅
- **GUI兼容**：确保生成的JMX文件在GUI模式下可打开

## 断言设计最佳实践
- **判责明确**：明确系统问题与测试设计问题的判责标准
- **场景化断言**：设计场景化的断言逻辑
- **错误信息**：提供清晰、详细的错误信息
- **边界考虑**：考虑边界情况的断言设计

## 上下游关联最佳实践
- **提取规则**：基于实际响应体结构设计提取规则
- **变量命名**：使用清晰、一致的变量命名规范
- **传递链条**：确保变量传递链条完整、正确
- **依赖处理**：妥善处理接口间复杂的依赖关系

# 参考规范

## A5三件套参考
- **role.prompt.md**：参考核心能力和行为准则
- **workflow.md**：参考阶段执行流程和宪法级约束
- **mistakes.md**：参考常见错误类型和解决方案

## 关键参考点
1. **接口链路可达性**：按依赖顺序执行前置接口，捕获输出并注入后续接口
2. **断言设计与判责**：明确系统问题与测试设计问题的判责标准
3. **上下游关联**：自动提取和传递变量，处理接口间依赖关系
4. **GUI兼容性**：确保脚本在GUI模式下可正常打开
5. **JSON字段提取**：基于实际响应体结构动态推理正确的字段访问路径
6. **参数动态生成**：处理时间戳、随机数、UUID等动态参数的生成和传递
7. **业务规则变更**：分析业务规则变更的影响，调整断言逻辑
8. **有限自愈**：单阶段重试 ≤3次，超过阈值请求人工介入

## 执行原则
- **阶段化执行**：按步骤执行测试方法，确保执行顺序正确
- **验证充分**：对测试方法执行结果进行充分验证
- **文档完整**：生成完整的测试方法文档和执行计划
- **持续改进**：定期总结经验教训，不断优化测试方法设计