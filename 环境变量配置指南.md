# 环境变量配置指南

## 概述

本项目使用环境变量来管理敏感配置信息，包括数据库凭据、API密钥等。这样可以避免将敏感信息硬编码在代码中，提高代码的安全性。

## 快速开始

### 1. 创建 .env 文件

在项目根目录下，复制 `.env.example` 文件并重命名为 `.env`：

```bash
# Windows PowerShell
Copy-Item .env.example .env

# Linux/Mac
cp .env.example .env
```

### 2. 填入实际配置值

编辑 `.env` 文件，将所有的占位符替换为实际的配置值：

```bash
# 示例：将占位符替换为实际值
REDIS_PASSWORD=patchx_dev_redis%$$1
PG_PASSWORD=MdXMPkaAwsJavi8q
AZURE_SPEECH_KEY=your_real_azure_key_here
SAUC_APP_KEY=your_real_sauc_app_key_here
SAUC_ACCESS_KEY=your_real_sauc_access_key_here
```

### 3. 加载环境变量

Python脚本会自动从环境变量中读取配置。您可以选择以下方式之一来加载环境变量：

#### 方式1：使用 python-dotenv（推荐）

安装 python-dotenv：

```bash
pip install python-dotenv
```

在脚本开头添加：

```python
from dotenv import load_dotenv
load_dotenv()  # 加载 .env 文件
```

#### 方式2：手动设置环境变量

在运行脚本前手动设置环境变量：

```bash
# Windows PowerShell
$env:REDIS_PASSWORD="your_password"
python your_script.py

# Linux/Mac
export REDIS_PASSWORD="your_password"
python your_script.py
```

## 配置项说明

### Redis 数据库配置

| 环境变量 | 说明 | 默认值 | 必填 |
|---------|------|--------|------|
| REDIS_HOST | Redis服务器地址 | redis-shzles67xmx2vg9oz.redis.volces.com | 否 |
| REDIS_PORT | Redis服务器端口 | 6379 | 否 |
| REDIS_USERNAME | Redis用户名 | zhanglijie | 否 |
| REDIS_PASSWORD | Redis密码 | YOUR_REDIS_PASSWORD | **是** |
| REDIS_DB | Redis数据库编号 | 0 | 否 |

**使用场景**：
- [query_user_info.py](python/utils/query_user_info.py) - 用户信息查询
- [clear_user_info.py](python/utils/clear_user_info.py) - 用户信息清除

### PostgreSQL 数据库配置

| 环境变量 | 说明 | 默认值 | 必填 |
|---------|------|--------|------|
| PG_HOST | PostgreSQL服务器地址 | postgres-460bae9aa91b-public.rds-pg.volces.com | 否 |
| PG_PORT | PostgreSQL服务器端口 | 5432 | 否 |
| PG_USER | PostgreSQL用户名 | zhanglijie | 否 |
| PG_PASSWORD | PostgreSQL密码 | YOUR_PG_PASSWORD | **是** |
| PG_DATABASE | PostgreSQL数据库名称 | patchx_emomo | 否 |

**使用场景**：
- [query_user_info.py](python/utils/query_user_info.py) - 用户信息查询
- [clear_user_info.py](python/utils/clear_user_info.py) - 用户信息清除

### Azure TTS 服务配置

| 环境变量 | 说明 | 默认值 | 必填 |
|---------|------|--------|------|
| AZURE_SPEECH_KEY | Azure Speech Services API密钥 | YOUR_AZURE_SPEECH_KEY | **是** |
| AZURE_SPEECH_REGION | Azure服务区域 | eastasia | 否 |

**使用场景**：
- [azure_config.py](python/azure_tts/azure_config.py) - Azure TTS配置
- [azure_tts_mixer.py](python/azure_tts/azure_tts_mixer.py) - TTS音频混合
- [generate_vad_samples.py](python/vad_test/generate_vad_samples.py) - VAD测试样本生成
- [generate_audacity_ready_samples.py](python/audio_processing/generate_audacity_ready_samples.py) - 音频样本生成

**Azure区域说明**：
- `eastasia` - 东亚（香港）
- `southeastasia` - 东南亚（新加坡）
- `centralus` - 美国中部
- `eastus` - 美国东部

### SAUC ASR 服务配置

| 环境变量 | 说明 | 默认值 | 必填 |
|---------|------|--------|------|
| SAUC_APP_KEY | SAUC应用密钥 | YOUR_SAUC_APP_KEY | **是** |
| SAUC_ACCESS_KEY | SAUC访问密钥 | YOUR_SAUC_ACCESS_KEY | **是** |

**使用场景**：
- [sauc_websocket_demo.py](python/sauc_websocket_demo.py) - SAUC WebSocket ASR演示

## 安全最佳实践

### 1. 永远不要提交 .env 文件

`.env` 文件包含敏感信息，必须添加到 `.gitignore` 中：

```gitignore
# 环境变量配置文件（包含敏感信息）
.env
```

### 2. 使用 .env.example 作为模板

`.env.example` 文件可以安全地提交到版本控制系统，作为配置模板供其他开发者参考。

### 3. 定期轮换密钥

建议定期更换API密钥和数据库密码，提高安全性。

### 4. 使用不同的环境配置

为开发、测试、生产环境使用不同的配置：

```bash
# 开发环境
.env.dev

# 测试环境
.env.test

# 生产环境
.env.prod
```

### 5. 限制文件权限

确保 `.env` 文件只有当前用户可以读取：

```bash
# Linux/Mac
chmod 600 .env

# Windows
# 右键文件 -> 属性 -> 安全 -> 编辑权限
```

## 故障排查

### 问题1：环境变量未生效

**症状**：脚本运行时提示缺少配置或使用默认值

**解决方案**：
1. 确认 `.env` 文件存在且在项目根目录
2. 检查环境变量名称是否正确（区分大小写）
3. 确认已安装并正确使用 `python-dotenv`

### 问题2：数据库连接失败

**症状**：提示连接超时或认证失败

**解决方案**：
1. 检查数据库地址和端口是否正确
2. 确认用户名和密码是否正确
3. 检查网络连接和防火墙设置
4. 验证数据库服务是否正常运行

### 问题3：API调用失败

**症状**：提示认证失败或密钥无效

**解决方案**：
1. 确认API密钥是否正确
2. 检查密钥是否已过期
3. 验证API服务是否可用
4. 检查配额是否已用完

## 示例：完整的 .env 文件

```bash
# Redis 数据库配置
REDIS_HOST=redis-shzles67xmx2vg9oz.redis.volces.com
REDIS_PORT=6379
REDIS_USERNAME=zhanglijie
REDIS_PASSWORD=patchx_dev_redis%$$1
REDIS_DB=0

# PostgreSQL 数据库配置
PG_HOST=postgres-460bae9aa91b-public.rds-pg.volces.com
PG_PORT=5432
PG_USER=zhanglijie
PG_PASSWORD=MdXMPkaAwsJavi8q
PG_DATABASE=patchx_emomo

# Azure TTS 服务配置
AZURE_SPEECH_KEY=your_real_azure_key_here
AZURE_SPEECH_REGION=eastasia

# SAUC ASR 服务配置
SAUC_APP_KEY=your_real_sauc_app_key_here
SAUC_ACCESS_KEY=your_real_sauc_access_key_here
```

## 相关文件

- [.env.example](.env.example) - 环境变量配置模板
- [.gitignore](.gitignore) - Git忽略文件配置
- [python/azure_tts/azure_config.py](python/azure_tts/azure_config.py) - Azure TTS配置示例
- [python/utils/query_user_info.py](python/utils/query_user_info.py) - 数据库查询示例

## 参考资料

- [python-dotenv 官方文档](https://github.com/theskumar/python-dotenv)
- [Azure Speech Services 文档](https://docs.microsoft.com/azure/cognitive-services/speech-service/)
- [SAUC ASR 文档](https://openspeech.bytedance.com/)
